= Making an API in a Mule 4 Application Available Through Autodiscovery
ifndef::env-site,env-github[]
include::_attributes.adoc[]
endif::[]

== Making Your API Available Through Autodiscovery

To make an API from your Mule 4.x application available through Autodiscovery, you must do the following:

. Make your Mule application available in the API Manager.
. In the API Manager, set up your Mule application as the API proxy.
. Configure the Mule Runtime to start with your organization's credentials.
. Verify that your Mule application is configured for Autodiscovery.

=== Making Your API Available in API Manager

First, make your API in your Mule application available in the API Manager.+
You can either:

* Publish your API in Exchange and import it from there to API Manager. +
See xref:manage-exchange-api-task.adoc[To Manage an API from Exchange].
* Import your API directly from your machine. +
See xref:import-api-task.adoc[To Import an API Instance] for more details.

Make a note of the "API ID" identifier generated by the API Manager:

image::api-id.png[align=center]

You'll need to specify this API ID when enabling your application to use Autodiscovery.

=== Set Up Your Mule Application as the API Proxy

Next, set up your Mule application to be the API proxy. In the API Manager:

. From the *Managing type* dropdown, select *Basic Endpoint*.
. In the *Implementation URI* field, enter the URL of the endpoint for your deployed Mule application.
. Select the checkmark *Check this box if you are managing this API in Mule 4 or above*.

=== Configuring Anypoint Platform Organization Credentials in Mule Runtime

To use Autodiscovery in a Mule Application, you must configure the Anypoint Platform credentials before starting the Runtime. +
For instructions, see xref:org-credentials-config-mule4.adoc[Configuring Organization Credentials in Mule Runtime 4].

=== Verifying That Your Mule Application Is Configured For Autodiscovery

Configuring the proxy endpoint for your API should add the Autodiscovery element to your Mule application automatically.

In your Mule application, open the `<xxx>` file, and verify that the `api-gateway:Autodiscovery` element is in the `<xxx>` tag
and is configured correctly.

The element should look like this:

.XML element
[source,xml,linenums]
----
<api-gateway:autodiscovery
  apiId="${apiId"
  flowRef="myFlow" />
----

If the element is not present or is not configured correctly, you can either edit the file or use Anypoint Studio to update the configuration settings.

If you want to update the configuration by editing the file:

. Add the `<api-gateway:autodiscovery>` element in the `<xxx>` element.
. Set the `apiId` attribute to the API ID generated by the API Manager. +
  If you want to be able to change this API ID easily:
.. Create a `config.properties` file.
.. Add `apiId=[your-specific-value]` to the file.
.. In the `<api-gateway:autodiscovery>` element, leave `apiId` set to `${apiId}`.
. Set the `flowRef` attribute to the flow for your Mule application.

If you want to use Anypoint Studio to update the configuration:

. In your existing flow, select the Global Elements tab in your Mule Configuration File editor.
. Click the Create button, and look for the API Autodiscovery global element.
+
image::auto-discovery-studio-7.png[align=center]
. Set the API ID and Flow Reference. +
+
image::auto-discovery-api-config.png[align=center]
+
You can also choose to use the `${apiId}` value and reference it from a `config.properties` file.

After the element is defined in the application, and the runtime is configured  with your Anypoint Platform credentials, Mule Runtime will automatically track and keep up to date with the API configuration. defined in API Manager.
//_COMBAK: Does this need to be deployed for the green dot to show in API Manager?

== Changes from Mule 3.x Configuration

API Autodiscovery element has syntactically changed from Mule 3.x but its purpose remains the same. The element in a Mule Application has the following format:

[%header%autowidth.spread,cols="a,a"]
|===
^| Mule 3.x XML element ^| Mule 4.x XML element
^| <api-platform-gw:api (...)/>. ^| <api-gateway:autodiscovery (...)/>.
|===

In Mule 4, the API is identified by the API Id and a reference to a Flow where the HTTP listener is defined. Mule 4â€™s apiId replaces the apiName and apiVersion used to specify the Autodiscovery element in Mule 3.x and prior.

== See Also

* xref:api-auto-discovery-new-concept.adoc[Reviewing API Gateway API Autodiscovery concepts
